# 48. Deploying a GraphQL Server on a VPS / Cloud

---

### 1. Introduction

In this chapter, we see how to put a GraphQL server ‚Äúlive‚Äù on the internet.
Think of it like taking a project from your laptop and placing it on a rented computer in the cloud so others can use it.

We will keep it simple:

* Use a **Linux VPS** (a small server on the internet).
* Use **Docker** to package the GraphQL app.
* Use **Nginx** as a ‚Äúgatekeeper‚Äù in front of the app.

You don‚Äôt need deep DevOps knowledge. Just follow the steps like a recipe.

---

### 2. Why this matters

As a backend developer, you don‚Äôt want your app to run only on your laptop. You want:

* Frontend apps (web, mobile) to call your GraphQL server from anywhere.
* A stable environment, not broken every time someone updates Node/Python.
* Easy redeploy: pull new code, rebuild, restart container.

Deploying with Docker + Nginx on a VPS is a **simple, repeatable pattern**. You can use the same idea for many projects.

---

### 3. Real-life example

Imagine you built a **clinic GraphQL API**:

* `query { patient(id: 1) { name visits { date } } }`
* `mutation { addVisit(...) { id } }`

On your laptop it runs at:
`http://localhost:4000/graphql`

Now:

* A **React frontend** is deployed somewhere else.
* Doctors want to use this app from their clinics.

So you:

1. Rent a small Linux VPS on a cloud provider.
2. Put your GraphQL server there.
3. Put Nginx in front so the world can reach it at:

   * `https://api.my-clinic-app.com/graphql`

The VPS is like **a permanent computer in a data center**, always on, serving your GraphQL buffet to all clients.

---

### 4. Code Examples (small & clear)

We‚Äôll assume a **Node + Apollo** style GraphQL server, but the idea is same for Python, etc.

#### 4.1 Project structure (on your dev machine)

```text
graphql-server/
  package.json
  src/
    index.js   # main entry
  schema/
    ...
```

Your server listens on port 4000:

```js
// src/index.js (very simplified)
import { ApolloServer } from '@apollo/server';
import { startStandaloneServer } from '@apollo/server/standalone';
import typeDefs from './schema/typeDefs.js';
import resolvers from './schema/resolvers.js';

const server = new ApolloServer({ typeDefs, resolvers });

const start = async () => {
  const { url } = await startStandaloneServer(server, {
    listen: { port: 4000 },
  });
  console.log(`üöÄ Server ready at ${url}`);
};

start();
```

---

#### 4.2 Dockerfile for the GraphQL server

This wraps your server into a container.

```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm install --production

COPY . .

ENV PORT=4000
EXPOSE 4000

CMD ["node", "src/index.js"]
```

---

#### 4.3 docker-compose.yml

This file says how to run your GraphQL container.

```yaml
# docker-compose.yml
version: "3.9"

services:
  graphql:
    build: .
    container_name: graphql_server
    restart: always
    ports:
      - "4000:4000"
    environment:
      - NODE_ENV=production
      - PORT=4000
```

Later, Nginx will **not** talk to your app via port 4000 from outside.
Nginx and the GraphQL server will talk **inside** the server using internal ports.

For a more ‚Äúprod‚Äù style, you can avoid exposing 4000 publicly and let Nginx proxy to it using Docker networks. But this simple version is okay to start.

---

#### 4.4 Nginx as reverse proxy

Nginx receives HTTPS/HTTP traffic on port 80/443 and forwards `/graphql` to your app.

A simple Nginx config (e.g., `/etc/nginx/conf.d/graphql.conf`):

```nginx
server {
    listen 80;
    server_name api.my-clinic-app.com;

    location /graphql {
        proxy_pass http://127.0.0.1:4000/graphql;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }
}
```

Later you can add **HTTPS** using Let‚Äôs Encrypt + Certbot.

---

#### 4.5 Step-by-step deployment flow (high-level)

On your **Linux VPS** (Ubuntu, for example):

1. **Update server & install tools**

   ```bash
   sudo apt update && sudo apt upgrade -y
   sudo apt install -y git nginx docker.io docker-compose
   sudo systemctl enable docker
   ```

2. **Clone your project**

   ```bash
   cd /opt
   sudo git clone https://github.com/yourname/graphql-server.git
   cd graphql-server
   ```

3. **Build and run with Docker Compose**

   ```bash
   sudo docker-compose build
   sudo docker-compose up -d
   ```

   Check containers:

   ```bash
   sudo docker ps
   ```

4. **Configure Nginx**

   * Create `/etc/nginx/conf.d/graphql.conf` with config shown above.
   * Test and reload:

     ```bash
     sudo nginx -t
     sudo systemctl reload nginx
     ```

5. **Set DNS**

   * On your domain provider, point `api.my-clinic-app.com` to the VPS IP.

6. **Test**

   * Open in browser: `http://api.my-clinic-app.com/graphql`
   * Or call from frontend using the new URL.

---

#### 4.6 REST vs GraphQL in deployment context

Deployment pattern is very similar:

* **REST**:

  * Nginx ‚Üí REST server ‚Üí DB
* **GraphQL**:

  * Nginx ‚Üí GraphQL server ‚Üí many services/DBs

You just have **one GraphQL endpoint** instead of many REST endpoints.
But the VPS, Docker, Nginx setup is almost the same.

---

### 5. Simple Text Diagram

Deployment view:

```text
Browser / Mobile App
        |
        v
  api.my-clinic-app.com
        |
      Nginx
        |
        v
  GraphQL Server (Docker container)
        |
        v
   Databases / REST services / other microservices
```

And from a ‚Äúcomputer‚Äù perspective:

```text
[Your laptop]
  |
  |   git push
  v
[Linux VPS]
  |
  |-- Docker builds image with your code
  |-- docker-compose up (container running port 4000)
  |
  |-- Nginx listens on port 80/443 and sends /graphql to port 4000
```

---

### 6. How to Instruct Codex to Automate This

Here are copy-paste prompts you (or your students) can use with Codex.
Replace brackets like `[your repo URL]`, `[domain-name]`, etc.

1. **Step-by-step deployment guide (given prompt)**

   > ‚ÄúGenerate a step-by-step deployment guide for this GraphQL server on a Linux VPS using Docker and Nginx. The server is a Node + Apollo app listening on port 4000. Include commands to install Docker, clone the repo, build the Docker image, run with docker-compose, and configure Nginx as a reverse proxy for /graphql.‚Äù

2. **Ask Codex to write Dockerfile + docker-compose**

   > ‚ÄúHere is my Node + Apollo GraphQL server entry file (index.js). Generate a Dockerfile and docker-compose.yml so that the server runs on port 4000 in production. Use NODE_ENV=production and explain each section in comments in simple English.‚Äù

3. **Ask Codex to generate Nginx config**

   > ‚ÄúGenerate an Nginx config for a GraphQL server running on [http://127.0.0.1:4000/graphql](http://127.0.0.1:4000/graphql). The public domain will be api.[my-domain].com. Show me where to put the file in /etc/nginx, how to test the config, and how to reload Nginx.‚Äù

4. **Ask Codex to add HTTPS (optional, next level)**

   > ‚ÄúExtend this deployment guide to include HTTPS using Let‚Äôs Encrypt and Certbot on Ubuntu. Explain the commands in simple language and show the updated Nginx config with SSL enabled.‚Äù

5. **Ask Codex for ‚Äòupdate and redeploy‚Äô flow**

   > ‚ÄúWrite a short guide for how to update the GraphQL server code on the VPS: pull from git, rebuild the Docker image, restart with docker-compose, and verify that the new version is running. Keep it in 8‚Äì10 simple steps.‚Äù

---

### 7. Summary

* Deploying a GraphQL server on a VPS is like moving your app from your laptop to a **permanent internet computer**.
* Using **Docker + Nginx** gives you a clean, repeatable way to run and expose your GraphQL endpoint.
* Codex can help you **generate Dockerfiles, Nginx configs, and step-by-step deployment guides**, so you focus on the GraphQL logic instead of memorizing every command.

