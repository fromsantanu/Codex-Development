# 50. API Gateway / Nginx in Front

*Routing, security & clean entry point*

---

### 1. Introduction

In this chapter, we learn how **Nginx** works as an **API gateway** for your GraphQL server.

Think of Nginx as the **reception desk** of a hospital:

* Visitors (clients/browsers) talk only to the reception.
* The receptionist decides **where** to send each request.
* The receptionist blocks suspicious people and allows only valid requests.

Your GraphQL server stays inside, safe and organized, while Nginx handles all incoming traffic.

---

### 2. Why this matters

Having Nginx in front gives you:

* **One public entry point** (`https://api.myapp.com`)
* Easy **routing** (send `/graphql` to GraphQL server, `/files` to another service)
* **Security features** like request limits, blocking certain IPs, SSL handling
* Ability to run **multiple backend services** behind the same domain

This is especially useful when your system grows into microservices.

---

### 3. Real-life example

Imagine a clinic system:

* `/graphql` → main GraphQL server
* `/images` → file storage server
* `/admin` → admin dashboard backend

To the outside world, everything looks like one clean API:

```
https://api.clinic-care.in/graphql  
https://api.clinic-care.in/images  
https://api.clinic-care.in/admin
```

Inside the VPS, Nginx routes each path to the correct service.

It works exactly like a hospital receptionist sending:

* patients → doctor room
* delivery trucks → storage room
* staff → admin office

---

### 4. Code Examples (small & clear)

Below is a beginner-friendly Nginx config that:

* Listens on port 80 or HTTPS 443
* Forwards `/graphql` to your GraphQL server running at `http://127.0.0.1:4000/graphql`
* Adds required headers for websockets & requests
* Protects backend from direct access

---

### 4.1 Example Nginx config with explanation

Save this as:
`/etc/nginx/conf.d/graphql.conf`

```nginx
server {
    listen 80;
    server_name api.myapp.com;

    # ---------------------------------------------------------
    # 1. This block handles requests to /graphql
    # ---------------------------------------------------------
    location /graphql {
        # Send the request to your GraphQL server running on port 4000
        proxy_pass http://127.0.0.1:4000/graphql;

        # Keep HTTP version modern for better compatibility
        proxy_http_version 1.1;

        # Allow WebSocket upgrades (subscriptions)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Forward the original Host header (useful for logs)
        proxy_set_header Host $host;

        # Forward real client IP to backend
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # Timeouts (useful for long-running queries)
        proxy_read_timeout 300;
    }

    # ---------------------------------------------------------
    # 2. Simple health check endpoint (optional)
    # ---------------------------------------------------------
    location /health {
        return 200 "OK\n";
    }
}
```

---

### 4.2 Explanation of each important directive (simple language)

| Directive                                   | Meaning in simple words                                        |
| ------------------------------------------- | -------------------------------------------------------------- |
| `listen 80;`                                | Nginx listens on port 80 (HTTP).                               |
| `server_name api.myapp.com;`                | This config activates only for this domain.                    |
| `location /graphql {…}`                     | Everything under `/graphql` goes to GraphQL server.            |
| `proxy_pass http://127.0.0.1:4000/graphql;` | Send request to your GraphQL app running locally on port 4000. |
| `proxy_set_header Host $host;`              | Tell backend which domain client originally asked for.         |
| `proxy_set_header X-Real-IP $remote_addr;`  | Send real client IP to the backend.                            |
| `proxy_set_header X-Forwarded-For …`        | For logs: chain of all proxies that handled the request.       |
| `proxy_http_version 1.1;`                   | Needed for WebSockets + long connections.                      |
| `proxy_set_header Upgrade/Connection`       | Makes GraphQL subscriptions work.                              |
| `proxy_read_timeout 300;`                   | Prevents timeout for heavy queries.                            |

---

### 4.3 Optional: Add HTTPS with SSL

If you already enabled SSL with Certbot, your config becomes:

```nginx
server {
    listen 443 ssl;
    server_name api.myapp.com;

    ssl_certificate     /etc/letsencrypt/live/api.myapp.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.myapp.com/privkey.pem;

    location /graphql {
        proxy_pass http://127.0.0.1:4000/graphql;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

Then add a redirect from HTTP to HTTPS:

```nginx
server {
    listen 80;
    server_name api.myapp.com;
    return 301 https://$host$request_uri;
}
```

---

### 5. Text Diagram (simple and clear)

```
Client Browser
      |
      v
  HTTPS Request
      |
      v
     Nginx   ← SSL termination, routing, IP filtering
      |
      +-- /graphql  → GraphQL Server (port 4000)
      |
      +-- /files    → File Service
      |
      +-- /admin    → Admin Backend
```

Nginx is the **gateway** that decides the path.

---

### 6. How to Instruct Codex

Copy-paste these prompts for your students or personal automation.

---

#### Prompt 1 — Nginx routing config

> “Write an Nginx config example that routes /graphql to my GraphQL server running at [http://127.0.0.1:4000/graphql](http://127.0.0.1:4000/graphql) and explain each directive in simple words.”

---

#### Prompt 2 — Add SSL + redirect

> “Extend the same Nginx config to include HTTPS using a Let’s Encrypt certificate, and add a redirect from HTTP to HTTPS. Keep the explanation simple.”

---

#### Prompt 3 — API gateway for multiple services

> “Generate an Nginx config that routes /graphql to GraphQL server, /files to a static folder, and /admin to another backend running at [http://127.0.0.1:5000](http://127.0.0.1:5000). Explain how Nginx decides where to send each request.”

---

#### Prompt 4 — Add basic security rules

> “Add request size limits and simple IP rate limits to this Nginx config, and explain what each rule protects against.”

---

### 7. Summary

* Nginx acts like a **reception desk** for your whole backend.
* Routes `/graphql` → GraphQL server and keeps it safe.
* Handles SSL, headers, rate limits, timeouts, and logs.
* Works as your **API gateway** when your system grows.

With this, your GraphQL deployment becomes professional, scalable, and secure.

