# 53. Small Clinic System — Patients + Visits + Bills

### 1. Introduction

In this chapter, we build a **small clinic system** using GraphQL.

Entities:

* **Patient** – basic info
* **Visit** – each time the patient comes to the clinic
* **Bill** – payment for a visit

We will:

* Design a **GraphQL schema**
* Add **resolvers** on the backend
* Build a **simple admin frontend** (React example, plus a tiny NiceGUI idea)

Think of this as a small “**reception + billing desk**” for a clinic.

---

### 2. Why this matters

A small clinic often needs to:

* Register patients
* Record each visit (doctor, date, reason)
* Create and view bills

With **REST**, you might have:

* `/patients`
* `/visits`
* `/bills`

And the admin UI needs to call many endpoints and join the data.

With **GraphQL**, you can ask in **one query**:

```graphql
query {
  patient(id: "p1") {
    name
    visits {
      visitDate
      doctorName
      bill {
        amount
        status
      }
    }
  }
}
```

One query → **full picture** of patient + visits + bills.
This is perfect for an **admin dashboard**.

---

### 3. Use-case story (real-life example)

Imagine a small **clinic** with:

* One receptionist
* One doctor
* One simple computer system

The receptionist wants to:

* Search for a **patient**
* See all **visits** for that patient
* Quickly see if each visit’s **bill** is paid or due

Instead of opening 3 different screens or doing 3 different API calls, the receptionist just opens one **Patient Detail** page that shows:

* Patient details
* List of visits
* Bill info per visit

GraphQL makes it easy to serve this from **one API**.

---

### 4. Code Examples

We use **Node + Apollo Server** for backend in examples, and **React** for admin UI.
You can easily adapt this to Python or another stack.

#### 4.1 GraphQL Schema (SDL)

```graphql
# clinic.graphql

type Patient {
  id: ID!
  name: String!
  age: Int
  phone: String
  address: String
  visits: [Visit!]!
}

type Visit {
  id: ID!
  patientId: ID!
  visitDate: String!
  doctorName: String!
  reason: String
  bill: Bill
}

type Bill {
  id: ID!
  visitId: ID!
  amount: Float!
  status: String! # PAID, UNPAID, PARTIAL
  createdAt: String!
}

type Query {
  patients: [Patient!]!
  patient(id: ID!): Patient
  visitsByPatient(patientId: ID!): [Visit!]!
  billsByPatient(patientId: ID!): [Bill!]!
}

input PatientInput {
  name: String!
  age: Int
  phone: String
  address: String
}

input VisitInput {
  patientId: ID!
  visitDate: String!
  doctorName: String!
  reason: String
}

input BillInput {
  visitId: ID!
  amount: Float!
  status: String!
}

type Mutation {
  addPatient(input: PatientInput!): Patient!
  addVisit(input: VisitInput!): Visit!
  addBill(input: BillInput!): Bill!
  updateBillStatus(billId: ID!, status: String!): Bill!
}
```

**In simple words:**

* `Patient` has many `visits`.
* Each `Visit` has **one** `bill`.
* Queries let the admin **read** data.
* Mutations let the admin **add** and **update** data.

#### 4.2 Simple In-Memory Data (for demo)

```js
// db.js (fake in-memory storage for demo)

const patients = [];
const visits = [];
const bills = [];

module.exports = { patients, visits, bills };
```

#### 4.3 Resolvers (Backend Logic)

```js
// resolvers.js
const { patients, visits, bills } = require("./db");

let idCounter = 1;

const resolvers = {
  Query: {
    patients: () => patients,
    patient: (_, { id }) => patients.find((p) => p.id === id),
    visitsByPatient: (_, { patientId }) =>
      visits.filter((v) => v.patientId === patientId),
    billsByPatient: (_, { patientId }) => {
      const patientVisits = visits.filter((v) => v.patientId === patientId);
      const visitIds = new Set(patientVisits.map((v) => v.id));
      return bills.filter((b) => visitIds.has(b.visitId));
    },
  },

  Mutation: {
    addPatient: (_, { input }) => {
      const newPatient = { id: `P${idCounter++}`, ...input };
      patients.push(newPatient);
      return newPatient;
    },
    addVisit: (_, { input }) => {
      const newVisit = { id: `V${idCounter++}`, ...input };
      visits.push(newVisit);
      return newVisit;
    },
    addBill: (_, { input }) => {
      const newBill = {
        id: `B${idCounter++}`,
        createdAt: new Date().toISOString(),
        ...input,
      };
      bills.push(newBill);
      return newBill;
    },
    updateBillStatus: (_, { billId, status }) => {
      const bill = bills.find((b) => b.id === billId);
      if (!bill) {
        throw new Error("Bill not found");
      }
      bill.status = status;
      return bill;
    },
  },

  Patient: {
    visits: (parent) => visits.filter((v) => v.patientId === parent.id),
  },

  Visit: {
    bill: (parent) => bills.find((b) => b.visitId === parent.id) || null,
  },
};

module.exports = resolvers;
```

This is simple, but enough to **demo**:

* Add patients
* Add visits
* Add bills
* Link them together in the GraphQL layer.

#### 4.4 Admin Frontend – React (Patient List + Detail)

**GraphQL queries (frontend):**

```js
// clinicQueries.js
export const LIST_PATIENTS_QUERY = `
  query {
    patients {
      id
      name
      phone
    }
  }
`;

export const PATIENT_DETAIL_QUERY = `
  query PatientDetail($id: ID!) {
    patient(id: $id) {
      id
      name
      age
      phone
      address
      visits {
        id
        visitDate
        doctorName
        reason
        bill {
          id
          amount
          status
        }
      }
    }
  }
`;
```

**Patient List Page:**

```jsx
// PatientListPage.jsx
import React, { useEffect, useState } from "react";
import { LIST_PATIENTS_QUERY } from "./clinicQueries";

export function PatientListPage({ onSelectPatient }) {
  const [patients, setPatients] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    async function load() {
      const res = await fetch("http://localhost:4000/graphql", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query: LIST_PATIENTS_QUERY }),
      });
      const json = await res.json();
      setPatients(json.data.patients);
      setLoading(false);
    }

    load();
  }, []);

  if (loading) return <div>Loading patients…</div>;

  return (
    <div>
      <h2>Patients</h2>
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Phone</th>
          </tr>
        </thead>
        <tbody>
          {patients.map((p) => (
            <tr key={p.id} onClick={() => onSelectPatient(p.id)} style={{ cursor: "pointer" }}>
              <td>{p.name}</td>
              <td>{p.phone}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}
```

**Patient Detail Page:**

```jsx
// PatientDetailPage.jsx
import React, { useEffect, useState } from "react";
import { PATIENT_DETAIL_QUERY } from "./clinicQueries";

export function PatientDetailPage({ patientId }) {
  const [patient, setPatient] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!patientId) return;

    async function load() {
      const res = await fetch("http://localhost:4000/graphql", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          query: PATIENT_DETAIL_QUERY,
          variables: { id: patientId },
        }),
      });
      const json = await res.json();
      setPatient(json.data.patient);
      setLoading(false);
    }

    load();
  }, [patientId]);

  if (!patientId) return <div>Select a patient.</div>;
  if (loading) return <div>Loading patient details…</div>;
  if (!patient) return <div>No patient found.</div>;

  return (
    <div style={{ marginLeft: "2rem" }}>
      <h2>Patient Details</h2>
      <p><strong>Name:</strong> {patient.name}</p>
      <p><strong>Age:</strong> {patient.age}</p>
      <p><strong>Phone:</strong> {patient.phone}</p>
      <p><strong>Address:</strong> {patient.address}</p>

      <h3>Visits & Bills</h3>
      {patient.visits.length === 0 ? (
        <p>No visits yet.</p>
      ) : (
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Doctor</th>
              <th>Reason</th>
              <th>Bill Amount</th>
              <th>Bill Status</th>
            </tr>
          </thead>
          <tbody>
            {patient.visits.map((v) => (
              <tr key={v.id}>
                <td>{v.visitDate}</td>
                <td>{v.doctorName}</td>
                <td>{v.reason}</td>
                <td>{v.bill ? v.bill.amount : "-"}</td>
                <td>{v.bill ? v.bill.status : "No bill"}</td>
              </tr>
            ))}
          </tbody>
        </table>
      )}
    </div>
  );
}
```

**Simple Admin Shell:**

```jsx
// ClinicAdminApp.jsx
import React, { useState } from "react";
import { PatientListPage } from "./PatientListPage";
import { PatientDetailPage } from "./PatientDetailPage";

export function ClinicAdminApp() {
  const [selectedPatientId, setSelectedPatientId] = useState(null);

  return (
    <div style={{ display: "flex", padding: "1rem" }}>
      <PatientListPage onSelectPatient={setSelectedPatientId} />
      <PatientDetailPage patientId={selectedPatientId} />
    </div>
  );
}
```

Now the admin can:

* See list of patients
* Click a patient
* See visits + bills in one screen

#### 4.5 Tiny NiceGUI Admin Example (Idea)

If you prefer **NiceGUI** (Python):

```python
# app.py (very small idea)
from nicegui import ui
import requests

GRAPHQL_URL = 'http://localhost:4000/graphql'

PATIENTS_QUERY = '''
query {
  patients {
    id
    name
    phone
  }
}
'''

def load_patients():
  res = requests.post(GRAPHQL_URL, json={'query': PATIENTS_QUERY})
  return res.json()['data']['patients']

patients_table = ui.table(columns=[
    {'name': 'name', 'label': 'Name', 'field': 'name'},
    {'name': 'phone', 'label': 'Phone', 'field': 'phone'},
], rows=[], row_key='id')

@ui.page('/')
def main_page():
  patients_table.rows = load_patients()

ui.run()
```

This can be extended to show details, forms, etc., using the **same GraphQL API**.

---

### 5. Diagram

```text
[Admin Browser or NiceGUI UI]
                |
                v
        [GraphQL Server]
                |
        +-------+--------+
        |                |
   [Patient Store]   [Visit Store]
                        |
                        v
                    [Bill Store]
```

Simple flow:

1. Admin UI sends a **GraphQL query**.
2. GraphQL server reads/writes data from **patients**, **visits**, **bills**.
3. Response comes back as **one JSON object** with nested structure.

---

### 6. How to instruct Codex to automate this

You can make Codex build almost the entire project.

Here are copy-paste prompts:

1. **Full backend + frontend (main prompt):**

   > “Generate the full GraphQL backend and a basic admin frontend (React or NiceGUI) for a small clinic: patients, visits, bills. Include schema, resolvers, and simple pages to list patients and show visits + bills.”

2. **Backend only:**

   > “Using Node.js and Apollo Server, create a GraphQL schema and resolvers for a small clinic system with Patient, Visit, and Bill. Use in-memory arrays for data so I can run it quickly.”

3. **React admin UI:**

   > “Generate React components for a clinic admin panel that call this GraphQL API: a PatientList page and a PatientDetail page showing visits and bills. Use fetch and keep the code very simple.”

4. **NiceGUI admin UI:**

   > “Create a NiceGUI app in Python that calls this GraphQL backend. Show a table of patients and a simple detail view that loads visits and bills for the selected patient.”

---

### 7. Summary

1. A **small clinic system** needs to handle **patients**, **visits**, and **bills** in a clean way.
2. GraphQL helps by exposing a **unified schema** where the admin can see all related data in one query.
3. A simple **admin frontend** (React or NiceGUI) can call this GraphQL server and give the receptionist and doctor a clear view of each patient’s history and billing status.

