# Chapter 45 – **Project 4: File Upload + Processing App** 

---

## 1. Simple Introduction

In this project, we build a small web app where the user can:

* **Upload a CSV or Excel file**
* The **backend API** reads it and creates a **summary**
* The frontend:

  * shows a **file upload box**
  * shows a **progress indicator** while the file is processed
  * displays a **results table and charts**

We will use:

* **Backend**: FastAPI
* **Frontend**: Streamlit (for simplicity)

Codex will help with:

* file upload code
* reading CSV/Excel safely
* handling errors (wrong file type, missing columns)
* generating chart code

---

## 2. Real-Life Analogy

Imagine a small **accounts office**:

* The accountant gets a new Excel sheet of **monthly sales**.
* They upload it into a **tool**.
* The tool:

  * reads the sheet
  * shows **total sales** and **sales per product**
  * shows **simple charts**, instead of raw numbers

Our project is exactly this kind of tool.

---

## 3. Key Concepts (Explained Gently)

### ✔️ File Upload UI

A widget on the page where the user can drag and drop or browse for a file.

### ✔️ Backend File Endpoint

API that accepts a file, reads it (CSV/Excel), and returns:

* summary numbers
* grouped data (e.g., total by product)
* anything we want to show on the dashboard

### ✔️ Progress Indicator

A visual sign (“Processing…”) so the user knows something is happening.

### ✔️ Results Table & Charts

* Table to display processed data
* Charts (bar/line) to show trends

### ✔️ Error Handling

We must handle:

* no file uploaded
* wrong file type
* file with missing required columns

---

## 4. Step-by-Step Explanation

### Step 1 – Design Backend Response

Backend will:

1. Accept **CSV/Excel** file
2. Convert file to **pandas DataFrame**
3. Calculate some simple summary:

   * total rows
   * total amount (if there is an `amount` column)
   * grouped sum by `category` (if present)
4. Return JSON like:

```json
{
  "summary": {
    "total_rows": 100,
    "total_amount": 25000.5
  },
  "by_category": [
    {"category": "A", "amount": 10000},
    {"category": "B", "amount": 15000.5}
  ]
}
```

### Step 2 – Build Backend Upload Endpoint (FastAPI)

* Use `UploadFile` in FastAPI.
* Detect file type from extension.
* Use `pandas.read_csv` or `pandas.read_excel`.

### Step 3 – Build Streamlit Frontend

* `st.file_uploader` for CSV/Excel
* A **button** to “Process file”
* When clicked:

  * show `st.spinner("Processing...")`
  * send file to backend using `requests.post`
  * get JSON result
  * display summary metrics, table, and chart

### Step 4 – Use Codex

* Ask Codex to generate:

  * file upload endpoint
  * CSV/Excel reading logic
  * error handling (`try/except`)
  * chart code using `plotly` or `st.bar_chart`

---

## 5. Backend Example (FastAPI + Pandas)

```python
# backend/main.py
from fastapi import FastAPI, UploadFile, File, HTTPException
from fastapi.middleware.cors import CORSMiddleware
import pandas as pd
from typing import List

app = FastAPI()

# allow frontend running on another port
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # for demo only
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.post("/process-file")
async def process_file(file: UploadFile = File(...)):
    filename = file.filename.lower()

    try:
        content = await file.read()

        if filename.endswith(".csv"):
            df = pd.read_csv(pd.io.common.BytesIO(content))
        elif filename.endswith(".xlsx") or filename.endswith(".xls"):
            df = pd.read_excel(pd.io.common.BytesIO(content))
        else:
            raise HTTPException(status_code=400, detail="Unsupported file type. Please upload CSV or Excel.")

        total_rows = len(df)

        # assume there is an 'amount' column, handle if not present
        total_amount = float(df["amount"].sum()) if "amount" in df.columns else 0.0

        # group by 'category' if column exists
        by_category: List[dict] = []
        if "category" in df.columns and "amount" in df.columns:
            grouped = df.groupby("category")["amount"].sum().reset_index()
            by_category = grouped.to_dict(orient="records")

        return {
            "summary": {
                "total_rows": total_rows,
                "total_amount": total_amount,
                "columns": list(df.columns),
            },
            "by_category": by_category,
        }

    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Error processing file: {e}")
```

---

## 6. Frontend Example (Streamlit)

### 6.1 Basic Layout + File Upload

```python
# frontend/app.py
import streamlit as st
import requests
import pandas as pd
import plotly.express as px

API_URL = "http://localhost:8000/process-file"

st.title("File Upload + Processing App")

uploaded_file = st.file_uploader("Upload CSV or Excel file", type=["csv", "xlsx", "xls"])
```

### 6.2 Button + Progress Indicator + API Call

```python
if uploaded_file is not None:
    if st.button("Process File"):
        # show progress / spinner
        with st.spinner("Uploading and processing..."):
            try:
                # prepare file for requests
                files = {
                    "file": (uploaded_file.name, uploaded_file.getvalue(), uploaded_file.type)
                }

                response = requests.post(API_URL, files=files)
                if response.status_code != 200:
                    st.error(f"Backend error: {response.text}")
                else:
                    data = response.json()

                    summary = data["summary"]
                    by_category = data["by_category"]

                    st.subheader("Summary")
                    col1, col2, col3 = st.columns(3)
                    col1.metric("Total Rows", summary["total_rows"])
                    col2.metric("Total Amount", f"{summary['total_amount']:.2f}")
                    col3.write(f"Columns: {', '.join(summary['columns'])}")

                    # show table and chart if category data exists
                    if by_category:
                        st.subheader("Amount by Category")
                        df_cat = pd.DataFrame(by_category)
                        st.dataframe(df_cat)

                        fig = px.bar(df_cat, x="category", y="amount", title="Amount by Category")
                        st.plotly_chart(fig, use_container_width=True)
                    else:
                        st.info("No 'category' and 'amount' columns for grouped chart.")

            except Exception as e:
                st.error(f"Error: {e}")
else:
    st.info("Please upload a CSV or Excel file to begin.")
```

> This shows a **spinner** while the file is being processed.
> After that, it shows summary metrics, table, and chart.

---

### 6.3 Simple Text Diagram

```text
User (Browser)
      │
      ▼
 Streamlit Frontend
      │  (multipart/form-data with file)
      ▼
 FastAPI Backend (/process-file)
      │
      ▼
   Pandas (read CSV/Excel, compute summary)
      │
      ▼
 JSON Response → Frontend → Tables & Charts
```

---

## 7. How Codex Helps You Here

You can ask Codex to do almost all of this for you.

### Prompt 1 – Create File Upload Endpoint

> “Generate a FastAPI endpoint `/process-file` that accepts a CSV or Excel
> file using `UploadFile` and returns JSON summary with total rows,
> total of an `amount` column, and grouped sum by `category`.”

---

### Prompt 2 – Add Pandas Error Handling

> “Improve this FastAPI file upload code to handle errors if the file
> does not have `amount` or `category` columns. Return a clear
> message to the client instead of crashing.”

---

### Prompt 3 – Generate Streamlit Upload & Spinner

> “Generate a Streamlit app with `st.file_uploader` for CSV/Excel,
> send the file to `/process-file` backend using `requests.post`,
> show `st.spinner` while waiting, and then display metric boxes
> and a bar chart if `by_category` is present in the response.”

---

### Prompt 4 – Handle Wrong File Types Gracefully

> “Update this Streamlit code so that if the backend returns
> error 400 ‘Unsupported file type’, it shows `st.warning` with
> a friendly message and does not break.”

---

### Prompt 5 – Support Large Files (Optional)

> “Modify the FastAPI endpoint and Streamlit code to handle
> larger CSV files efficiently. Suggest using streaming or chunks
> in pandas if needed. Keep the example simple.”

---

## 8. Mini Exercises for Students

1. **Add Column Selection**

   * After processing, show a selectbox where user can pick which column to treat as `amount` and which as `category`.

2. **Add Downloadable Processed Data**

   * Let the backend also return a “cleaned” dataset.
   * In Streamlit, add “Download processed data as CSV”.

3. **Add More Charts**

   * Create another chart: for example, a pie chart of `amount` by `category`.

4. **Add Validation on Frontend**

   * If no file is uploaded, disable the “Process File” button.
   * Show a small note “Please upload a file first”.

---
