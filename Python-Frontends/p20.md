# **Chapter 20. Refreshing Data and Auto-Update**

## **1. Simple Introduction**

Sometimes the data in your dashboard **keeps changing**.

Examples:

* number of patients waiting
* sales numbers
* new orders
* live status updates

Your UI needs a way to **refresh the data** so the user always sees the latest information.

This chapter teaches you:

* how to add a **manual refresh** button
* how to create **auto-refresh** using a simple timer
* how to show a **loading spinner** or â€œLoadingâ€¦â€ message
* how to keep the UI smooth and responsive

---

## **2. Real-Life Analogy**

Imagine a **news bulletin board** at a railway station.

* The staff can update the board manually when trains arrive or leave.
* But if the board updates **automatically every minute**, passengers donâ€™t need to ask anyone.

Software dashboards are similar:

* **Manual refresh** = user pressing a button
* **Auto-refresh** = system updates itself
* **Loading indicator** = â€œPlease wait while we update the boardâ€

---

## **3. Key Concepts (Explained Gently)**

### âœ”ï¸ Manual Refresh Button

A simple button like â€œğŸ”„ Refresh Dataâ€ that fetches the latest data from the API.

---

### âœ”ï¸ Auto-Refresh (Timer)

The UI re-fetches the data every few seconds.

Examples:

* every 5 seconds
* every 1 minute

Enough for most dashboards.

---

### âœ”ï¸ Loading State

When the app is fetching data, show:

* spinner
* â€œLoadingâ€¦â€ message
* greyed-out area

This helps users understand that new data is coming.

---

### âœ”ï¸ Avoid Too-Frequent Refresh

Refreshing every second can overload:

* your backend
* your API limits
* your userâ€™s computer

Prefer 5â€“60 seconds.

---

### âœ”ï¸ Cache vs No Cache

When refreshing, always call the API directly, not a cached result.

---

## **4. Step-by-Step Explanation**

### **Step 1: Add a manual refresh button**

The button triggers the API call and reloads the table or chart.

---

### **Step 2: Keep a â€œloadingâ€ variable**

Before the API call: set `loading = True`
After the call finishes: set `loading = False`

Use this to show a spinner.

---

### **Step 3: Implement auto-refresh**

Use a timer or repeat loop:

* Streamlit â†’ `st.experimental_rerun()` inside a loop
* NiceGUI â†’ `ui.timer()`

---

### **Step 4: Re-fetch API data**

When refresh happens, call the API again and redraw:

* tables
* cards
* charts

---

### **Step 5: Prevent flicker**

Donâ€™t clear the whole page every refresh.

---

## **5. Example UI Code â€“ Streamlit**

### ğŸ”¹ Manual Refresh + Spinner

```python
import streamlit as st
import requests
import time

st.title("Live Patient Count")

if "data" not in st.session_state:
    st.session_state.data = None

def fetch_data():
    with st.spinner("Loading latest data..."):
        response = requests.get("http://localhost:8000/dashboard/patients")
        st.session_state.data = response.json()
        time.sleep(0.2)  # quick delay for nicer UX

# --- Manual refresh ---
if st.button("ğŸ”„ Refresh"):
    fetch_data()

# Auto-load the data when the app starts
if st.session_state.data is None:
    fetch_data()

st.metric("Patients Waiting", st.session_state.data["waiting"])
```

This example shows:

* refresh button
* loading spinner
* metric card

---

### ğŸ”¹ Auto-Refresh (Streamlit Simple Approach)

Streamlit does not have a direct timer, but you can use **st.experimental_rerun** inside a loop:

```python
import streamlit as st
import requests
import time

st.title("Auto-Refreshing Patient Count")

refresh_rate = 5  # seconds

response = requests.get("http://localhost:8000/dashboard/patients")
data = response.json()

st.metric("Patients Waiting", data["waiting"])
st.write(f"Auto-refresh in {refresh_rate} seconds...")

time.sleep(refresh_rate)
st.experimental_rerun()
```

Now the data refreshes every 5 seconds.

---

## **5b. Example UI Code â€“ NiceGUI**

### ğŸ”¹ Manual Refresh in NiceGUI

```python
from nicegui import ui
import requests

def refresh():
    label.set_text("Loading...")
    data = requests.get("http://localhost:8000/dashboard/patients").json()
    label.set_text(f"Patients Waiting: {data['waiting']}")

label = ui.label("Loading...")
refresh()

ui.button("ğŸ”„ Refresh", on_click=refresh)

ui.run()
```

---

### ğŸ”¹ Auto-Refresh with ui.timer()

This is the **cleanest** auto-update solution.

```python
from nicegui import ui
import requests

label = ui.label()

def update_data():
    data = requests.get("http://localhost:8000/dashboard/patients").json()
    label.set_text(f"Patients Waiting: {data['waiting']}")

update_data()  # load once on start

# --- Auto refresh every 5 seconds ---
ui.timer(5.0, update_data)

ui.run()
```

This makes the data automatically refresh every 5 seconds.

---

### ğŸ”¹ Auto-Refresh + Spinner in NiceGUI

```python
from nicegui import ui
import requests

label = ui.label()
spinner = ui.spinner().props('size=30 color=primary')
spinner.visible = False

def update_data():
    spinner.visible = True
    data = requests.get("http://localhost:8000/dashboard/patients").json()
    label.set_text(f"Waiting Patients: {data['waiting']}")
    spinner.visible = False

update_data()
ui.timer(10, update_data)

ui.button("Manual Refresh", on_click=update_data)

ui.run()
```

---

## **6. Backend API Example**

### **Request**

```
GET /dashboard/patients
```

### **Response**

```json
{
  "waiting": 14,
  "in_progress": 5,
  "completed": 9
}
```

Your frontend should:

* fetch this again on refresh
* update the metrics

---

## **7. How Codex Helps You Here**

You can use prompts like:

### âœ”ï¸ Prompt 1 â€“ Add manual refresh

> â€œCodex, add a refresh button that re-fetches data from `/dashboard/patients` and updates the metric card.â€

### âœ”ï¸ Prompt 2 â€“ Add auto-refresh

> â€œCodex, add auto-refresh every 10 seconds using NiceGUIâ€™s `ui.timer`.â€

### âœ”ï¸ Prompt 3 â€“ Add loading spinner

> â€œCodex, wrap the API call inside a spinner so the user sees a loading message while fetching data.â€

### âœ”ï¸ Prompt 4 â€“ Optimize refresh logic

> â€œCodex, refactor this code so refreshing does not recreate the entire layout each time.â€

### âœ”ï¸ Prompt 5 â€“ Error handling

> â€œCodex, show a â€˜Could not load dataâ€™ message if the API fails or returns invalid JSON.â€

---

## **8. Mini Exercises for Students**

### ğŸŸ¦ Exercise 1 â€“ Simple manual refresh

Create a Streamlit app:

* show â€œTotal Orders Todayâ€
* add a refresh button
* fetch from `/orders/today`

---

### ğŸŸ¦ Exercise 2 â€“ Simple auto-refresh

Using NiceGUI's `ui.timer`, refresh data every **3 seconds** from:

`/temperature/current`

---

### ğŸŸ¦ Exercise 3 â€“ Spinner

Add a spinner that appears only when fetching API data.

---

### ğŸŸ¦ Exercise 4 â€“ Combined

Create a dashboard with:

* refresh button
* auto-refresh every 10 seconds
* loading text/spinner
* one metric + one table

---
