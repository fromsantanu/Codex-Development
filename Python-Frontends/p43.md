# Chapter 43 – Project 2: **Sales Dashboard with Filters** 

---

## 1. Simple Introduction

In this project, we will build a **Sales Dashboard**.

This dashboard will help a shop or company answer questions like:

* “How much did we sell this month?”
* “Which product is selling best?”
* “How do sales change over months?”

We will build:

* **Backend (FastAPI)**

  * Endpoint: sales summary
  * Endpoint: sales by product
  * Endpoint: sales by month

* **Frontend (Streamlit)**

  * Date range filter
  * Product filter
  * Charts and tables that update when filters change

We will also see how **Codex can write chart code and layout** for us.

---

## 2. Real-Life Analogy

Think of a **shop owner** who wants to quickly see:

* Total sales between 1st and 15th of a month
* Which product (e.g., “Shoes”, “Bags”) is selling more
* How sales change month by month

Earlier, he might open an Excel file and filter manually.

Our **Sales Dashboard** is like a **smart Excel sheet**:

* You choose **date range** → dashboard shows updated numbers.
* You choose **product** → dashboard shows that product’s sales.
* You see **charts** instead of raw numbers, so it’s easier to understand.

---

## 3. Key Concepts (Explained Gently)

### ✔️ Sales Summary

A small box (or table) that shows key numbers:

* Total sales amount
* Total number of orders

### ✔️ Sales by Product

Shows **how much each product sold**.
Usually as a **bar chart** or **table**.

### ✔️ Sales by Month

Shows **sales per month**, often as a **line chart** or **bar chart**.

### ✔️ Filters

* **Date range filter**: like telling the dashboard “show me only this time period”.
* **Product filter**: like telling the dashboard “show me only this product”.

### ✔️ API Calls from Dashboard

The frontend (Streamlit) asks:

* “Give me sales summary for this date range and product.”
* “Give me sales by product for this date range.”
* “Give me sales by month for this date range and product.”

Backend returns JSON data. Frontend turns it into **tables and charts**.

---

## 4. Step-by-Step Explanation

### Step 1 – Design Backend Endpoints

We create three endpoints:

1. `GET /sales/summary`

   * Input: start_date, end_date, product (optional)
   * Output: total_sales, total_orders

2. `GET /sales/by-product`

   * Input: start_date, end_date
   * Output: list of `{product_name, sales_amount}`

3. `GET /sales/by-month`

   * Input: start_date, end_date, product (optional)
   * Output: list of `{month, sales_amount}`

These can be calculated from a simple in-memory list or from a database.

---

### Step 2 – Build Streamlit Frontend Layout

We will create:

1. **Filter section at the top**

   * Date range input
   * Product select box

2. **Summary section**

   * Show total sales and total orders

3. **Charts and tables**

   * Bar chart: sales by product
   * Line/bar chart: sales by month
   * Data tables under the charts

---

### Step 3 – Connect Filters → API Calls

When user changes date or product:

* Streamlit calls backend APIs with chosen filters.
* Backend returns filtered data.
* Streamlit redraws charts and tables.

---

### Step 4 – Let Codex Help

We can ask Codex to:

* Generate the **chart code** (using matplotlib or plotly).
* Improve the **layout** (columns, spacing).
* Add **nice labels** and **titles**.

---

## 5. Backend API Example (FastAPI – Simple Demo)

Here we use an in-memory list as our “database” just to show the idea.

```python
from fastapi import FastAPI
from pydantic import BaseModel
from typing import List, Optional
from datetime import date

app = FastAPI()

class Sale(BaseModel):
    date: date
    product: str
    amount: float

# Dummy data
sales_db = [
    Sale(date=date(2025, 1, 1), product="Shoes", amount=1000),
    Sale(date=date(2025, 1, 5), product="Bags", amount=500),
    Sale(date=date(2025, 2, 3), product="Shoes", amount=700),
    Sale(date=date(2025, 2, 10), product="Hats", amount=300),
]

def filter_sales(start_date: date, end_date: date, product: Optional[str] = None):
    result = []
    for s in sales_db:
        if start_date <= s.date <= end_date:
            if product is None or s.product == product:
                result.append(s)
    return result

@app.get("/sales/summary")
def sales_summary(start_date: date, end_date: date, product: Optional[str] = None):
    filtered = filter_sales(start_date, end_date, product)
    total_sales = sum(s.amount for s in filtered)
    total_orders = len(filtered)
    return {"total_sales": total_sales, "total_orders": total_orders}

@app.get("/sales/by-product")
def sales_by_product(start_date: date, end_date: date):
    filtered = filter_sales(start_date, end_date)
    totals = {}
    for s in filtered:
        totals[s.product] = totals.get(s.product, 0) + s.amount
    return [{"product": p, "sales_amount": amt} for p, amt in totals.items()]

@app.get("/sales/by-month")
def sales_by_month(start_date: date, end_date: date, product: Optional[str] = None):
    filtered = filter_sales(start_date, end_date, product)
    month_totals = {}
    for s in filtered:
        key = f"{s.date.year}-{s.date.month:02d}"
        month_totals[key] = month_totals.get(key, 0) + s.amount
    return [{"month": m, "sales_amount": amt} for m, amt in month_totals.items()]
```

---

## 6. Example UI Code (Streamlit – Filters, Charts, Tables)

### 6.1 Basic Layout with Filters

```python
import streamlit as st
import requests
from datetime import date

API = "http://localhost:8000"

st.title("Sales Dashboard")

# --- Filters ---
col1, col2 = st.columns(2)
with col1:
    start_date = st.date_input("Start date", value=date(2025, 1, 1))
with col2:
    end_date = st.date_input("End date", value=date(2025, 12, 31))

product = st.selectbox("Product (optional)", ["All", "Shoes", "Bags", "Hats"])

product_param = None if product == "All" else product
```

### 6.2 Calling Summary API and Showing KPIs

```python
params = {
    "start_date": start_date.isoformat(),
    "end_date": end_date.isoformat(),
}
if product_param:
    params["product"] = product_param

summary = requests.get(f"{API}/sales/summary", params=params).json()

st.subheader("Summary")
col_a, col_b = st.columns(2)
col_a.metric("Total Sales", f"{summary['total_sales']:.2f}")
col_b.metric("Total Orders", summary['total_orders'])
```

### 6.3 Sales by Product – Table + Chart

```python
import pandas as pd
import plotly.express as px

# by product
bp = requests.get(
    f"{API}/sales/by-product",
    params={
        "start_date": start_date.isoformat(),
        "end_date": end_date.isoformat()
    }
).json()

df_bp = pd.DataFrame(bp)

st.subheader("Sales by Product")
if not df_bp.empty:
    st.dataframe(df_bp)

    fig_bp = px.bar(df_bp, x="product", y="sales_amount", title="Sales by Product")
    st.plotly_chart(fig_bp, use_container_width=True)
else:
    st.info("No sales data for this period.")
```

### 6.4 Sales by Month – Chart + Table

```python
# by month
bm = requests.get(
    f"{API}/sales/by-month",
    params={
        "start_date": start_date.isoformat(),
        "end_date": end_date.isoformat(),
        "product": product_param,
    }
).json()

df_bm = pd.DataFrame(bm)

st.subheader("Sales by Month")
if not df_bm.empty:
    st.dataframe(df_bm)

    fig_bm = px.line(df_bm, x="month", y="sales_amount", markers=True,
                     title=f"Sales by Month ({product if product_param else 'All Products'})")
    st.plotly_chart(fig_bm, use_container_width=True)
else:
    st.info("No monthly data for this period.")
```

---

### 6.5 Simple Text Diagram of the Architecture

```text
User (Browser)
      │
      ▼
Streamlit Dashboard (Frontend)
      │
      ▼  HTTP (requests)
FastAPI Backend (Sales APIs)
      │
      ▼
  Data Source (DB or in-memory list)
```

---

## 7. How Codex Helps You Here (Chart Code + Layout)

Here are some **ready-to-use prompts** you or your students can give to Codex.

### Prompt 1 – Generate Sales Dashboard Layout

> “Generate a Streamlit app with a title ‘Sales Dashboard’,
> a date range filter, and a product select box, and show placeholders
> for summary metrics, ‘Sales by Product’ chart, and ‘Sales by Month’ chart.”

---

### Prompt 2 – Create Plotly Bar Chart from API Data

> “I have this JSON from /sales/by-product:
> `[{"product": "Shoes", "sales_amount": 1000}, {"product": "Bags", "sales_amount": 500}]`.
> Generate Streamlit code using plotly.express to draw a bar chart
> with product on X-axis and sales_amount on Y-axis.”

---

### Prompt 3 – Generate Line Chart by Month

> “Generate Streamlit + plotly.express code that takes a DataFrame with
> columns `month` and `sales_amount` and shows a line chart with markers,
> with nice axis labels and a title ‘Sales by Month’.”

---

### Prompt 4 – Improve Layout with Columns

> “Improve this Streamlit layout by putting filters in two columns,
> summary metrics in two columns below, and charts one after another.
> Keep the code simple and add short comments.”

---

### Prompt 5 – Add Error Handling for API Calls

> “Update this Streamlit code so that when the API call fails
> (non-200 status), it shows an error message using `st.error`
> instead of breaking the app.”

---

## 8. Mini Exercises for Students

Here are some small tasks your students can try:

1. **Add a “Category” Filter**

   * Pretend each product has a category (e.g., “Clothing”, “Accessories”).
   * Add a new dropdown for category and update backend + frontend.

2. **Add Average Order Value**

   * In the summary endpoint, also return `average_order_value`.
   * Show it as a third metric in the dashboard.

3. **Sort Sales by Month Correctly**

   * Currently, `month` is a string like `"2025-01"`.
   * Ensure the chart shows months in the correct time order, not alphabetically.

4. **Add Download CSV Button**

   * Allow the user to download sales-by-product or sales-by-month data as CSV.

---
