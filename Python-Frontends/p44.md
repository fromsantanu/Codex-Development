# Chapter 44 – **Project 3: Clinic Frontend (with AI/ML Backend)** 

---

## 1. Simple Introduction

Here we will build a **small clinic frontend** that talks to an **AI/ML backend**.

The backend can:

* give a **patient list**
* show **visit records** for a patient
* call an **ML model** that returns a **risk score** (for example: risk of complication, readmission, etc.)

The frontend (we’ll use **NiceGUI**) will have:

1. **Patient search page**
2. **Visit detail page** with prediction result and a small chart
3. **Form to send new symptoms** to an ML endpoint and show updated risk

We will also see how **Codex** can help to:

* call the ML API
* parse the JSON
* display results nicely with labels and charts

---

## 2. Real-Life Analogy

Think of this like a **clinic reception + doctor’s room**:

* Receptionist searches for a patient → **Patient Search Page**
* Doctor opens a visit → **Visit Detail Page**
* Doctor updates symptoms and clicks “Check Risk” → **Form to ML Model**

The AI/ML backend is like a **senior specialist** sitting in another room:

* You send the **symptoms and vitals**
* It sends back **“This patient has 0.78 risk”** + some explanation

Our frontend is the **nice screen** that shows all of this clearly.

---

## 3. Key Concepts (Explained Gently)

### ✔️ Patient List API

Returns a list like:

```json
[
  {"id": 1, "name": "Ravi Kumar", "age": 45},
  {"id": 2, "name": "Anita Singh", "age": 32}
]
```

### ✔️ Visit Records API

For one patient, returns visits:

```json
[
  {"visit_id": 10, "date": "2025-01-10", "reason": "Fever"},
  {"visit_id": 11, "date": "2025-02-05", "reason": "Follow-up"}
]
```

### ✔️ ML Prediction API

Takes symptoms and vitals, returns:

```json
{
  "risk_score": 0.78,
  "risk_level": "High",
  "explanation": "High fever and low oxygen saturation",
  "history": [
    {"date": "2025-01-10", "risk_score": 0.4},
    {"date": "2025-02-05", "risk_score": 0.6},
    {"date": "2025-03-01", "risk_score": 0.78}
  ]
}
```

### ✔️ Frontend Pages

* **Search page** → search box + patient table
* **Visit detail** → visit info + risk result + small chart
* **ML form** → input symptoms, send to backend, show new risk

---

## 4. Step-by-Step Explanation

We’ll do this in steps.

### Step 1 – Define Simple Backend APIs (FastAPI)

We will define:

1. `GET /patients` with optional `search`
2. `GET /patients/{pid}/visits`
3. `POST /ml/predict` (body = symptoms)

Internally the backend may call a real ML model (or just a dummy function for now).

---

### Step 2 – Design Clinic Frontend Pages (NiceGUI)

Pages:

1. `/patients` – **Patient search**

   * search box
   * table of patients
   * “View Visits” button

2. `/patient/{pid}` – **Visit list**

   * show patient name
   * table of visits
   * “Open Visit” button

3. `/visit/{visit_id}` – **Visit detail + prediction**

   * show visit date, reason, vitals
   * show current risk score + level
   * chart of risk history
   * **form**: update symptoms and vitals → call `/ml/predict` → show new risk

---

### Step 3 – Hook UI Buttons to API Calls

* Search field calls `/patients?search=...`
* Clicking “View Visits” goes to `/patient/{pid}` and calls `/patients/{pid}/visits`
* Visit page calls ML endpoint to get prediction
* Form on visit page sends new symptoms to `POST /ml/predict`

---

### Step 4 – Use Codex to Improve

We will use Codex to:

* write the **requests code**
* build **NiceGUI tables** and **charts**
* handle errors and empty responses
* clean up layout into columns, cards, etc.

---

## 5. Simple Backend Example (FastAPI + Dummy ML)

### 5.1 Patient and Visit APIs

```python
from fastapi import FastAPI
from pydantic import BaseModel
from typing import List, Optional
from datetime import date

app = FastAPI()

class Patient(BaseModel):
    id: int
    name: str
    age: int

class Visit(BaseModel):
    visit_id: int
    patient_id: int
    date: date
    reason: str

patients_db = [
    Patient(id=1, name="Ravi Kumar", age=45),
    Patient(id=2, name="Anita Singh", age=32),
]

visits_db = [
    Visit(visit_id=10, patient_id=1, date=date(2025,1,10), reason="Fever"),
    Visit(visit_id=11, patient_id=1, date=date(2025,2,5), reason="Follow-up"),
    Visit(visit_id=20, patient_id=2, date=date(2025,3,1), reason="Headache"),
]

@app.get("/patients")
def list_patients(search: Optional[str] = None) -> List[Patient]:
    if not search:
        return patients_db
    return [p for p in patients_db if search.lower() in p.name.lower()]

@app.get("/patients/{pid}/visits")
def patient_visits(pid: int) -> List[Visit]:
    return [v for v in visits_db if v.patient_id == pid]
```

### 5.2 ML Prediction API (Dummy Logic)

```python
class Symptoms(BaseModel):
    patient_id: int
    visit_id: Optional[int] = None
    fever: bool
    cough: bool
    spo2: float   # oxygen saturation
    heart_rate: int

class PredictionResult(BaseModel):
    risk_score: float
    risk_level: str
    explanation: str
    history: List[dict]

def dummy_risk(symptoms: Symptoms) -> PredictionResult:
    score = 0.1
    if symptoms.fever:
        score += 0.3
    if symptoms.cough:
        score += 0.2
    if symptoms.spo2 < 94:
        score += 0.3
    if symptoms.heart_rate > 100:
        score += 0.1

    level = "Low"
    if score > 0.7:
        level = "High"
    elif score > 0.4:
        level = "Medium"

    history = [
        {"date": "2025-01-10", "risk_score": 0.4},
        {"date": "2025-02-05", "risk_score": 0.6},
        {"date": "2025-03-01", "risk_score": score},
    ]

    return PredictionResult(
        risk_score=round(score, 2),
        risk_level=level,
        explanation=f"Computed from fever={symptoms.fever}, cough={symptoms.cough}, spo2={symptoms.spo2}, heart_rate={symptoms.heart_rate}",
        history=history,
    )

@app.post("/ml/predict", response_model=PredictionResult)
def predict(symptoms: Symptoms):
    return dummy_risk(symptoms)
```

---

## 6. Frontend Example (NiceGUI)

We’ll show:

* `/patients` → search + table
* `/patient/{pid}` → visit list
* `/visit/{visit_id}` → detail + ML form + chart

Assume:

```python
# main.py
from nicegui import ui
import requests
import pandas as pd
import plotly.express as px

API = "http://localhost:8000"
```

### 6.1 Patient Search Page

```python
@ui.page('/patients')
def patient_search_page():
    ui.label('Clinic – Patient Search').classes('text-xl font-bold')

    search_box = ui.input('Search patient by name')

    table = ui.table(
        columns=['id', 'name', 'age'],
        rows=[],
    )

    def load_patients():
        q = search_box.value or ''
        r = requests.get(f'{API}/patients', params={'search': q})
        rows = [p for p in r.json()]
        table.rows = rows

    search_box.on_change(lambda e: load_patients())
    ui.button('Refresh', on_click=load_patients)

    def view_visits(row):
        ui.navigate(f'/patient/{row["id"]}')

    table.add_slot('actions', lambda row: ui.button('View Visits', on_click=lambda: view_visits(row)))

    load_patients()
```

---

### 6.2 Patient Visit List Page

```python
@ui.page('/patient/{pid}')
def patient_visits_page(pid: int):
    pid = int(pid)
    ui.label(f'Patient {pid} – Visit List').classes('text-xl font-bold')

    # get patient info
    pr = requests.get(f'{API}/patients', params={})
    patient = next((p for p in pr.json() if p['id'] == pid), None)
    if patient:
        ui.label(f"Name: {patient['name']}, Age: {patient['age']}")

    # visits
    vr = requests.get(f'{API}/patients/{pid}/visits')
    visits = vr.json()

    table = ui.table(
        columns=['visit_id', 'date', 'reason'],
        rows=visits,
    )

    def open_visit(row):
        ui.navigate(f'/visit/{row["visit_id"]}')

    table.add_slot('actions', lambda row: ui.button('Open Visit', on_click=lambda: open_visit(row)))

    ui.button('Back to Patients', on_click=lambda: ui.navigate('/patients'))
```

---

### 6.3 Visit Detail + ML Prediction Page

```python
@ui.page('/visit/{visit_id}')
def visit_detail_page(visit_id: int):
    visit_id = int(visit_id)
    ui.label(f'Visit {visit_id} – Details & Risk Prediction').classes('text-xl font-bold')

    # For demo, find visit and patient
    vr = requests.get(f'{API}/patients/1/visits')  # simplified: assume patient_id=1
    visit = next((v for v in vr.json() if v['visit_id'] == visit_id), None)

    if visit:
        ui.label(f"Date: {visit['date']}")
        ui.label(f"Reason: {visit['reason']}")

    # --- ML Prediction Form ---
    ui.separator()
    ui.label('Current Symptoms and Vitals').classes('text-lg')

    fever = ui.checkbox('Fever')
    cough = ui.checkbox('Cough')
    spo2 = ui.number('SpO2 (%)', value=96)
    heart_rate = ui.number('Heart rate (bpm)', value=80)

    risk_label = ui.label('Risk: -')
    explanation_label = ui.label('Explanation: -')

    chart_container = ui.column()

    def call_ml():
        body = {
            "patient_id": 1,           # demo
            "visit_id": visit_id,
            "fever": fever.value,
            "cough": cough.value,
            "spo2": spo2.value,
            "heart_rate": heart_rate.value,
        }
        r = requests.post(f'{API}/ml/predict', json=body)
        if r.status_code != 200:
            risk_label.text = 'Risk: Error calling ML API'
            return

        data = r.json()
        risk_label.text = f"Risk: {data['risk_score']} ({data['risk_level']})"
        explanation_label.text = f"Explanation: {data['explanation']}"

        # Draw chart for history
        history = data.get('history', [])
        if history:
            df = pd.DataFrame(history)
            fig = px.line(df, x='date', y='risk_score', markers=True,
                          title='Risk Score Over Time')
            chart_container.clear()
            with chart_container:
                ui.plotly(fig)

    ui.button('Check Risk', on_click=call_ml)
    ui.button('Back to Visits', on_click=lambda: ui.navigate('/patient/1'))  # demo
```

---

### 6.4 Simple Text Diagram

```text
Doctor / Staff (User)
        │
        ▼
   NiceGUI Frontend
        │
        ▼  HTTP (requests)
 FastAPI Clinic Backend
        │
        ├── Patient DB (patients, visits)
        └── ML Service (risk prediction)
```

---

## 7. How Codex Helps You Here

Here are some **ready prompts**.

### Prompt 1 – Build Patient Search UI

> “Generate a NiceGUI page that calls `/patients` API,
> shows results in a table with columns id, name, age,
> and has a search input that sends the text as `search` query parameter.
> Add a ‘View Visits’ button for each row that navigates to `/patient/{id}`.”

---

### Prompt 2 – Integrate ML Prediction Endpoint

> “I have a FastAPI endpoint `POST /ml/predict` that expects JSON
> with fever (bool), cough (bool), spo2 (float), heart_rate (int).
> Generate NiceGUI code with checkboxes and number fields
> that sends this JSON to the endpoint and shows the risk_score,
> risk_level, and explanation returned in the response.”

---

### Prompt 3 – Draw Risk History Chart

> “Given JSON like `{"history": [{"date": "2025-01-10", "risk_score": 0.4}, ...]}`,
> generate Python code using pandas and plotly.express inside NiceGUI
> to draw a line chart of risk_score over date with markers.”

---

### Prompt 4 – Clean Up Layout and Add Cards

> “Improve this NiceGUI layout by placing patient info in a card,
> the symptom form in another card, and the chart below them.
> Make the code readable and add comments for each section.”

---

### Prompt 5 – Add Basic Error Handling

> “Update this NiceGUI + requests code so that if the backend returns
> a non-200 status, it shows `ui.notify('Error calling backend')`
> and does not crash. Keep the rest of the code simple.”

---

## 8. Mini Exercises for Students

1. **Add Vital History Table**

   * Extend the prediction result to also include recent vitals.
   * Show them in a small table under the chart.

2. **Add Risk Color Coding**

   * If `risk_level` is “High”, show the label in red,
   * “Medium” → orange, “Low” → green.

3. **Add Patient Filter on Visit Page**

   * Use the real `patient_id` instead of hard-coded `1`.
   * Pass `patient_id` from URL properly.

4. **Add “Save Prediction” Button**

   * After getting a risk result, send it to a new API
     like `POST /visits/{visit_id}/save_prediction` (you can mock it)
     and show a success message.

---
