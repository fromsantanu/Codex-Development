# **Chapter 30 — Calling Protected APIs from the Frontend**

## **1. Simple Introduction**

After a user logs in, we must use their **token** to call backend APIs that require permission.
These are called **protected APIs**.

Examples:

* `/patients/list`
* `/orders/history`
* `/profile/me`

These APIs **only work when a valid token is attached**.
If the token is missing or expired, the backend will return:

* **401** → “You are not logged in”
* **403** → “You are logged in but not allowed to access this resource”

In this chapter, we learn how to:

1. Attach the token to API calls
2. Detect 401/403 errors
3. Redirect the user back to the login screen

---

## **2. Real-Life Analogy**

Imagine going to a movie theatre:

* First you buy the ticket → token
* Then at each checkpoint, you must show your ticket → Authorization header
* If the ticket is missing → 401 (not logged in)
* If the ticket is valid but not for this hall → 403 (forbidden)
* If ticket expired → 401 again (must re-login)

Your frontend has to check these conditions and guide the user properly.

---

## **3. Key Concepts (Explained Gently)**

### **a) Protected API**

An API that requires a valid token.

### **b) Bearer Token Header**

Each request must include:

```
Authorization: Bearer <token>
```

### **c) 401 Unauthorized**

Token missing, expired, or invalid.
User must login again.

### **d) 403 Forbidden**

Token is valid, but the user does not have permission.
Example: a normal user trying to open an admin-only page.

### **e) Redirect to Login**

If the token is missing or expired, send the user back to the login page.

---

## **4. Step-by-Step Explanation**

### **Step 1: Read the token from session state**

If no token is present → redirect to login.

### **Step 2: Attach token to API calls**

Send it in the headers:

```python
headers = {
    "Authorization": f"Bearer {token}"
}
```

### **Step 3: Make the API call**

Use `requests.get()` or `requests.post()` with the headers.

### **Step 4: Check for 401/403**

If backend returns 401:

* Clear token
* Redirect user to login

If backend returns 403:

* Show “You do not have permission”

### **Step 5: Handle expired token**

If the backend says token expired, do the same as 401.

---

## **5. Example UI Code (Streamlit)**

This example shows how to call a protected API and redirect to login automatically.

```python
import streamlit as st
import requests

BASE_URL = "http://localhost:8000"

# Ensure token exists in session
if "token" not in st.session_state:
    st.session_state.token = None

def call_protected_api():
    """Call a backend API that needs a token."""
    if not st.session_state.token:
        st.warning("You are not logged in.")
        st.stop()

    headers = {
        "Authorization": f"Bearer {st.session_state.token}"
    }

    try:
        res = requests.get(f"{BASE_URL}/protected/data", headers=headers)

        # Handle 401 - not logged in / token invalid
        if res.status_code == 401:
            st.error("Your session expired. Please login again.")
            st.session_state.token = None
            st.stop()

        # Handle 403 - no permission
        if res.status_code == 403:
            st.error("You do not have permission to view this page.")
            st.stop()

        # If success
        if res.status_code == 200:
            st.success("Data loaded successfully!")
            st.json(res.json())
        else:
            st.error(f"Unknown error: {res.text}")

    except Exception as e:
        st.error(f"Error contacting server: {e}")

st.title("Protected API Demo")

# If logged in
if st.session_state.token:
    if st.button("Load Protected Data"):
        call_protected_api()

    if st.button("Logout"):
        st.session_state.token = None
        st.info("Logged out.")

# If not logged in
else:
    st.info("Please log in to access protected data.")
```

---

## **6. Backend API Example**

FastAPI example of a protected route:

```python
from fastapi import FastAPI, Depends, HTTPException, status
from fastapi.security import HTTPBearer
import jwt

app = FastAPI()

SECRET = "mysecret"
ALGO = "HS256"
auth = HTTPBearer()

def get_user(creds = Depends(auth)):
    token = creds.credentials
    try:
        decoded = jwt.decode(token, SECRET, algorithms=[ALGO])
        return decoded["sub"]
    except:
        raise HTTPException(status_code=401, detail="Invalid or expired token")

@app.get("/protected/data")
def protected_data(user: str = Depends(get_user)):
    return {"message": "Protected content", "user": user}
```

---

## **7. How Codex Can Help Here**

Below are prompts students can directly use with Codex:

### **Prompt 1**

“Generate a Streamlit helper function that calls a protected API with a Bearer token and handles 401/403 errors.”

### **Prompt 2**

“Improve this code by automatically redirecting to login when token is missing.”

### **Prompt 3**

“Create a FastAPI protected endpoint that checks JWT token and returns 401 if invalid.”

### **Prompt 4**

“Refactor my Streamlit app so that all protected pages share a single function for token checking.”

### **Prompt 5**

“Show me how to handle expired tokens gracefully in the frontend.”

Codex can produce reusable helper functions and fix error-handling logic.

---

## **8. Mini Exercises for Students**

### **Exercise 1:**

Create a helper function `api_get(url)` that:

* Automatically reads token from session
* Attaches token
* Handles 401/403
* Returns API response

### **Exercise 2:**

Make a simple menu where:

* “Login” appears when logged out
* “Dashboard” appears only when logged in
* Dashboard calls a protected API

### **Exercise 3:**

Simulate a role-based 403 error by returning:

```json
{"detail": "admin only"}
```

from backend, and show a friendly message on the frontend.

### **Exercise 4:**

Add a timeout error message if API is unreachable.

---
