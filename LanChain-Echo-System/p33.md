# **Chapter 33. Logging & Monitoring with LangSmith / LangFuse**

### **1. Simple Introduction**

When you build agents, they don’t always behave the way you expect:

* Sometimes they misunderstand the prompt
* Sometimes they skip steps
* Sometimes they call the wrong tool
* Sometimes they return too much or too little information

To improve them, you need **visibility**—a way to *see inside* what the agent is doing.

That’s where **LangSmith** and **LangFuse** help.
They work like CCTV cameras inside your agent’s brain:

* Track each step
* Record every prompt
* Record every response
* Record tool calls
* Show errors and timings

This makes debugging and improving agents much easier.

---

### **2. Real-Life Analogy**

Think of debugging agents like diagnosing a car problem.

If your car is not running smoothly:

* You want to see **speed**, **temperature**, **fuel**
* Maybe even error logs

LangSmith/LangFuse are like the **dashboard** and **mechanic’s toolkit**.

They help you answer:

* “What exactly happened?”
* “Where did the agent take the wrong turn?”
* “Why did the tool get wrong inputs?”

---

### **3. Why Logging & Monitoring Matter**

Real agent problems usually happen *inside*:

* Prompt is slightly wrong
* Model misinterprets instructions
* A tool is called with incomplete arguments
* Function output is misunderstood
* Agent loops or stops suddenly

Logs help you:

* Debug step-by-step
* Improve prompt quality
* Measure speed & cost
* Track user interactions
* Reproduce failures

Without logs, you are blind.

---

### **4. What LangSmith / LangFuse Do**

Both platforms give you:

1. **Tracing**

   * Every agent message
   * Every function/tool call
   * Every model call
   * Inputs and outputs
   * Timings and costs

2. **Debugging**

   * Look at a broken run
   * Compare a good run vs bad run
   * Inspect exact prompts the model saw

3. **Prompt Improvement Tools**

   * Edit prompts and re-run
   * A/B test prompt variants
   * Analyze where hallucinations happen
   * Find missing instructions

4. **Monitoring**

   * Success rate
   * Error rate
   * Latency (how long agent takes)
   * User activity

These dashboards make your agent more reliable.

---

### **5. Simple Workflow Diagram**

```
Agent Run
   |
   v
[ LangSmith / LangFuse Trace ]
   |
   |-- Inspect prompts
   |-- Inspect tool calls
   |-- Inspect errors
   |
   v
Better prompts / cleaner agents
```

---

### **6. Setting Up Logging (Very Simple)**

### **Example: LangSmith**

Install:

```bash
pip install langsmith
```

Environment variables:

```env
LANGSMITH_API_KEY=your-key-here
LANGSMITH_PROJECT=my-agent-project
```

Enable tracing:

```python
from langchain_openai import ChatOpenAI
from langchain.callbacks.manager import CallbackManager
from langsmith import Client

client = Client()

llm = ChatOpenAI(
    model="gpt-4o-mini",
    callbacks=CallbackManager(client.callbacks)
)
```

Now every agent run appears in LangSmith dashboard.

---

### **Example: LangFuse**

Install:

```bash
pip install langfuse
```

Environment variables:

```env
LANGFUSE_PUBLIC_KEY=public-key
LANGFUSE_SECRET_KEY=secret-key
LANGFUSE_HOST=https://cloud.langfuse.com
```

Enable it:

```python
from langfuse.callback import CallbackHandler
from langchain_openai import ChatOpenAI

handler = CallbackHandler()

llm = ChatOpenAI(
    model="gpt-4o-mini",
    callbacks=[handler]
)
```

Every model call now sends logs to LangFuse.

---

### **7. What You See in the Trace**

Let’s take an example:
Your agent is supposed to summarize text and generate an email.

The trace will show:

1. **User Input**

   ```
   "Please summarize this and prepare an email for my manager."
   ```

2. **Prompt the agent actually sees**
   Including system prompt + formatting + memory.

3. **Model Response**

   * Summary text
   * Email text

4. **Tool calls (if any)**
   e.g., “fetch document”, “send email”.

5. **Timing**

   * Model call took 1.2 seconds

6. **Cost**

   * 0.005 USD

7. **Error details** if something breaks

   * “Tool required field missing: subject”

This helps you pinpoint the exact error.

---

### **8. Improving Prompts with Logs**

A big advantage of LangSmith/LangFuse is **prompt editing**.

You can:

* Modify your system prompt
* Add missing rules
* Tighten instructions
* Avoid hallucinations
* Add examples

Then you can **re-run** the same input and compare results.

#### Example Prompt Fix

Original agent misbehaves:

* It answers with long paragraphs when you want short bullet points.

Tracing shows the model ignored your style.

Improved system prompt:

```
Give responses ONLY in 5–7 short bullet points.
Never generate long paragraphs.
```

Re-run → You see improvement.

---

### **9. Debugging Tool Calls**

Sometimes agents pass wrong arguments to tools like:

```python
search_tool.run(query=None)
```

or:

```python
db_tool.run({"customer_id": ""})
```

LangSmith/LangFuse trace shows:

```
Tool call failed: "customer_id" is empty or missing
```

Now you know exactly where to fix.

---

### **10. Monitoring in Production**

Once your agent is used by real users:

You can track:

* Number of daily runs
* Which prompts fail most
* Which prompts cost the most
* Which steps take longest
* How many errors occur
* Which users trigger failures

This helps in scaling and reliability.

---

### **11. Simple Example — Healthcare Symptom Agent Debugging**

User input:

```
"I have mild fever and headache for 2 days."
```

Trace shows:

1. Clean system prompt
2. Clean user message
3. Model output
4. Structured JSON
5. No diagnosis (good)
6. No unsafe suggestions (good)

If instead the model accidentally gives advice:

```
You may take XYZ medicine.
```

Trace helps you notice this immediately so you can correct your system prompt.

---

### **12. Summary**

LangSmith and LangFuse are essential tools for:

* **Tracing** complete agent runs
* **Debugging** prompts, errors, and tool calls
* **Improving** prompts using real examples
* **Monitoring** agents in production
* **Making your workflows more reliable and safe**

They act like:

* A **CCTV system** for your agent
* A **diagnostic toolkit**
* A **quality-improvement dashboard**

With good logs and monitoring, your agents become predictable, trustworthy, and easier to maintain.

---

